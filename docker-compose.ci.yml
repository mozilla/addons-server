# This docker compose file is a minimal override file that goes with
# docker-compose.yml and is intended to be used in CI to run tests without
# a full environment (without running `make up`).
#
# Aside from overring healthchecks and dependencies, it does not bind mount
# the repos to /data/olympia, relying only on the contents of the image as well
# as a named volume for deps as we need to install more on top for tests.
# Because it doesn't use the bind volume, the entrypoint is also overridden as
# all the usermod shenanigans don't apply.
#
# When running locally to test CI, be careful not to use a stale data_deps_ci
# volume.

services:
  web:
    # We don't want any healthchecks, this is to run a one-off pytest command.
    healthcheck: !override
      test: ['CMD','true']
    # Minimal dependencies. Jobs may start other services on their own.
    depends_on: !override
      mysqld:
        condition: service_healthy
      memcached:
        condition: service_started
    # We don't need to bind the local filesystem like we do for development,
    # but we do need a persistent deps volume to install dependencies used for
    # testing not present in the production image.
    # When mounting an empty volume into a directory on the container in which
    # files exist, those files are copied into the volume by default, which
    # means we'll only need to install development dependencies, the production
    # ones are already there.
    volumes: !override
      - data_deps_ci:/data/olympia/deps
    # Since we're not using a bind mount, we shouldn't use our development
    # entrypoint that runs commands as the host user uid.
    entrypoint: !reset ['CMD', 'bash']

volumes:
  data_deps_ci:
