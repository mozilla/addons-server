language: python
sudo: false

python:
- 2.7

env:
  global:
    - DISPLAY=:99.0

matrix:
  include:
    - python: 2.7
      env: TOXENV=flake8
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=docs
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=assets
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=es
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=addons
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=devhub
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=editors
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=amo
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=users
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env: TOXENV=main
      addons:
        apt:
          packages:
            - swig
    - python: 2.7
      env:
        - TOXENV=ui-tests
        - PYTEST_BASE_URL=http://localhost:8081
      addons:
        apt:
          packages:
            - swig
        firefox: latest
  exclude:
    - python: 2.7
  fast_finish: true

cache:
  pip: true
  directories:
    - node_modules
    - .tox

services:
  - memcached

before_install:
  - scripts/travis_es.sh
  - /tmp/elasticsearch/elasticsearch-1.6.2/bin/elasticsearch -d -D es.path.data=/tmp -D es.gateway.type=none -D es.index.store.type=memory -D es.discovery.zen.ping.multicast.enabled=false
  - wget -O /tmp/geckodriver.tar.gz https://github.com/mozilla/geckodriver/releases/download/v0.14.0/geckodriver-v0.14.0-linux64.tar.gz
  - mkdir $HOME/geckodriver && tar xvf /tmp/geckodriver.tar.gz -C $HOME/geckodriver
  - export PATH=$HOME/geckodriver:$PATH
  - firefox --version
  - geckodriver --version
install:
  - nvm current
  - nvm deactivate
  - nvm install 4
  - nvm use 4
  - pip install --upgrade pip wheel setuptools tox==1.8.1

before_script:
  - mysql -e 'create database olympia;'
  - node --version
  - if [[ "${TOXENV}" = "ui-tests" ]]; then sh -e /etc/init.d/xvfb start; fi
  - if [[ "${TOXENV}" = "ui-tests" ]]; then sleep 10; fi

script:
  - RUNNING_IN_CI=True tox -v

notifications:
  irc:
    channels:
      - "irc.mozilla.org#amo-bots"
    on_success: change
    on_failure: always
  webhooks:
    # trigger Buildtime Trend Service to parse Travis CI log
    - https://buildtimetrend.herokuapp.com/travis

git:
  depth: 3
