machine:
  services:
    - docker
  hosts:
    olympia.dev: 127.0.0.1

dependencies:
  override:
    - docker version
    - >
        printf '{"commit":"%s","version":"%s","source":"https://github.com/%s/%s","build":"%s"}\n'
        "$CIRCLE_SHA1"
        "$CIRCLE_TAG"
        "$CIRCLE_PROJECT_USERNAME"
        "$CIRCLE_PROJECT_REPONAME"
        "$CIRCLE_BUILD_URL"
        > version.json
    - docker build -t app:build -f Dockerfile.deploy .
    - pip install tox mozdownload mozinstall

test:
  pre:
    - mozdownload --version latest --destination firefox.tar.bz2
    - mozinstall firefox.tar.bz2
    - wget -O geckodriver.tar.gz https://github.com/mozilla/geckodriver/releases/download/v0.14.0/geckodriver-v0.14.0-linux64.tar.gz
    - gunzip -c geckodriver.tar.gz | tar xopf -
    - chmod +x geckodriver
    - sudo mv geckodriver /home/ubuntu/bin
    - docker-compose pull
    - docker-compose up -d
    - sleep 60
    - docker-compose run web ./scripts/setup-docker.sh
  override:
    - tox -e ui-tests --
      --base-url=http://127.0.0.1
      --firefox-path=firefox/firefox
      --junit-xml=$CIRCLE_TEST_REPORTS/junit.xml
      --html=$CIRCLE_ARTIFACTS/results.html

deployment:
  latest:
    branch: master
    commands:
      - docker tag app:build ${DOCKERHUB_REPO}:latest
      - docker login -e $DOCKERHUB_EMAIL -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
      - docker push ${DOCKERHUB_REPO}:latest

  releases:
    # push all tags
    tag: /.*/
    commands:
      - docker tag app:build ${DOCKERHUB_REPO}:${CIRCLE_TAG}
      - docker login -e $DOCKERHUB_EMAIL -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
      - docker push ${DOCKERHUB_REPO}:${CIRCLE_TAG}
