include:
  - path:
      - docker-compose._services.yml

services:
  worker:
    extends:
      file: docker-compose._base.yml
      service: worker
    # when running with a build context, always rebuild the image
    # relying on efficient caching to reduce build time
    pull_policy: build
    build:
      context: .
      dockerfile: Dockerfile
      # build to the specified target
      target: ${DOCKER_TARGET:-}
      # cache when github action cache is available
      # locally we cache to buildx managed volumes automatically
      cache_from:
        - type=gha
      cache_to:
        - type=gha,mode=max
      # currently we only support linux/amd64
      x-bake:
        platforms: linux/amd64
    volumes:
      - .:/data/olympia

  web:
    extends:
      service: worker
